# 16. UI ì„¤ê³„

## ë¬¸ì„œ ì •ë³´
- **ì‘ì„±ì¼**: 2025-10-30
- **í”„ë¡œì íŠ¸ëª…**: ë…¼ë¬¸ ë¦¬ë·° ì±—ë´‡ (AI Agent + RAG)
- **íŒ€ëª…**: ì—°ê²°ì˜ ë¯¼ì¡±

---

## 1. Streamlit ê¸°ë³¸ êµ¬ì¡°

### 1.1 í˜ì´ì§€ ì„¤ì •

```python
import streamlit as st

st.set_page_config(
    page_title="ë…¼ë¬¸ ë¦¬ë·° ì±—ë´‡",
    page_icon="ğŸ“š",
    layout="wide"
)

st.title("ğŸ“š ë…¼ë¬¸ ë¦¬ë·° ì±—ë´‡ (AI Agent + RAG)")
st.caption("ğŸ¤– LangGraph + RAG ê¸°ë°˜ ë…¼ë¬¸ ê²€ìƒ‰ ë° ì§ˆë¬¸ ë‹µë³€")
```

---

## 2. UI ì›Œí¬í”Œë¡œìš°

```mermaid
graph LR
    A[ğŸ‘¤ ì‚¬ìš©ì<br/>ì ‘ì†] --> B[ğŸšï¸ ë‚œì´ë„ ì„ íƒ<br/>Easy/Hard]
    B --> C[ğŸ’¬ ì§ˆë¬¸ ì…ë ¥<br/>ì±„íŒ…ì°½]
    C --> D{ğŸ¤– Agent<br/>ì²˜ë¦¬}

    D --> E1[ğŸ“„ ë…¼ë¬¸ ê²€ìƒ‰]
    D --> E2[ğŸŒ ì›¹ ê²€ìƒ‰]
    D --> E3[ğŸ“– ìš©ì–´ ì„¤ëª…]
    D --> E4[ğŸ“ ìš”ì•½]
    D --> E5[ğŸ’¾ íŒŒì¼ ì €ì¥]

    E1 --> F[âœ… ë‹µë³€ í‘œì‹œ<br/>ì¶œì²˜ í¬í•¨]
    E2 --> F
    E3 --> F
    E4 --> F
    E5 --> G[â¬‡ï¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ]

    F --> C
    G --> C

    %% ë…¸ë“œ ìŠ¤íƒ€ì¼
    style A fill:#81c784,stroke:#388e3c,stroke-width:2px,color:#000
    style B fill:#64b5f6,stroke:#1976d2,stroke-width:2px,color:#000
    style C fill:#64b5f6,stroke:#1976d2,stroke-width:2px,color:#000
    style D fill:#ba68c8,stroke:#7b1fa2,stroke-width:2px,color:#fff

    style E1 fill:#ce93d8,stroke:#7b1fa2,color:#000
    style E2 fill:#ce93d8,stroke:#7b1fa2,color:#000
    style E3 fill:#ce93d8,stroke:#7b1fa2,color:#000
    style E4 fill:#ce93d8,stroke:#7b1fa2,color:#000
    style E5 fill:#ce93d8,stroke:#7b1fa2,color:#000

    style F fill:#66bb6a,stroke:#2e7d32,stroke-width:2px,color:#fff
    style G fill:#66bb6a,stroke:#2e7d32,stroke-width:2px,color:#fff
```

---

## 3. ë‚œì´ë„ ì„ íƒ UI

### 3.1 ì‚¬ì´ë“œë°” êµ¬í˜„

```python
with st.sidebar:
    st.header("âš™ï¸ ì„¤ì •")

    # ë‚œì´ë„ ì„ íƒ
    difficulty = st.radio(
        "ğŸšï¸ ë‚œì´ë„ ì„ íƒ",
        options=["easy", "hard"],
        format_func=lambda x: "ì´ˆê¸‰ (ì‰¬ìš´ ì„¤ëª…)" if x == "easy" else "ì „ë¬¸ê°€ (ìƒì„¸ ì„¤ëª…)",
        index=0
    )

    st.divider()

    # ì •ë³´ í‘œì‹œ
    st.info("""
    **ì´ˆê¸‰ ëª¨ë“œ**: ì‰¬ìš´ ìš©ì–´, ë¹„ìœ ì™€ ì˜ˆì‹œ í™œìš©
    **ì „ë¬¸ê°€ ëª¨ë“œ**: ì „ë¬¸ ìš©ì–´, ìˆ˜ì‹ ë° ìƒì„¸ ë¶„ì„
    """)

    # ë¦¬ì…‹ ë²„íŠ¼
    if st.button("ğŸ”„ ëŒ€í™” ì´ˆê¸°í™”"):
        st.session_state.messages = []
        st.rerun()
```

---

## 4. ì±„íŒ… ì¸í„°í˜ì´ìŠ¤

### 4.1 ì±„íŒ… íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”

```python
# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if "messages" not in st.session_state:
    st.session_state.messages = []
```

### 4.2 ê¸°ì¡´ ë©”ì‹œì§€ í‘œì‹œ

```python
# ì±„íŒ… íˆìŠ¤í† ë¦¬ í‘œì‹œ
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])
```

### 4.3 ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬

```python
# ì‚¬ìš©ì ì…ë ¥
if prompt := st.chat_input("ë…¼ë¬¸ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”..."):
    # ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    st.session_state.messages.append({"role": "user", "content": prompt})

    with st.chat_message("user"):
        st.markdown(prompt)

    # Agent ì‹¤í–‰
    with st.chat_message("assistant"):
        message_placeholder = st.empty()

        # ìŠ¤íŠ¸ë¦¬ë° ì½œë°±
        st_callback = StreamlitCallbackHandler(st.container())

        # Agent í˜¸ì¶œ
        response = agent_executor.invoke(
            {"question": prompt, "difficulty": difficulty},
            config={"callbacks": [st_callback]}
        )

        answer = response["final_answer"]
        message_placeholder.markdown(answer)

    # ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ ì¶”ê°€
    st.session_state.messages.append({"role": "assistant", "content": answer})
```

---

## 5. StreamlitCallbackHandler í†µí•©

### 5.1 Agent ì‹¤í–‰ ì‹œê°í™”

```python
from langchain.callbacks import StreamlitCallbackHandler

# Callback Handler ìƒì„±
st_callback = StreamlitCallbackHandler(
    parent_container=st.container(),
    expand_new_thoughts=True,
    collapse_completed_thoughts=True
)

# Agent ì‹¤í–‰
response = agent_executor.invoke(
    {"question": question, "difficulty": difficulty},
    config={"callbacks": [st_callback]}
)
```

### 5.2 ì‹¤í–‰ ê³¼ì • í‘œì‹œ

StreamlitCallbackHandlerëŠ” ë‹¤ìŒì„ ìë™ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤:
- ğŸ”§ ì„ íƒëœ ë„êµ¬
- ğŸ” ê²€ìƒ‰ ê³¼ì •
- ğŸ’­ Agentì˜ ì‚¬ê³  ê³¼ì •
- âœ… ì™„ë£Œëœ ë‹¨ê³„

---

## 6. íŒŒì¼ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥

### 6.1 ë‹¤ìš´ë¡œë“œ ë²„íŠ¼

```python
def create_download_button(content, filename):
    """íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìƒì„±"""
    st.download_button(
        label="â¬‡ï¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ",
        data=content,
        file_name=filename,
        mime="text/plain"
    )
```

### 6.2 ì‚¬ìš© ì˜ˆì‹œ

```python
# ë‹µë³€ì— "íŒŒì¼ ì €ì¥" ìš”ì²­ì´ ìˆëŠ” ê²½ìš°
if "save" in response["tool_choice"]:
    content = response["final_answer"]
    filename = f"paper_summary_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"

    with st.chat_message("assistant"):
        st.success("âœ… íŒŒì¼ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!")
        create_download_button(content, filename)
```

---

## 7. ë¡œë”© ìƒíƒœ í‘œì‹œ

### 7.1 Spinner ì‚¬ìš©

```python
with st.spinner("ğŸ¤– ë‹µë³€ ìƒì„± ì¤‘..."):
    response = agent_executor.invoke({
        "question": prompt,
        "difficulty": difficulty
    })
```

### 7.2 Progress Bar

```python
progress_bar = st.progress(0)
status_text = st.empty()

# Agent ì‹¤í–‰ ì¤‘ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
for i in range(100):
    progress_bar.progress(i + 1)
    status_text.text(f"ì²˜ë¦¬ ì¤‘... {i+1}%")
    time.sleep(0.01)

progress_bar.empty()
status_text.empty()
```

---

## 8. ì—ëŸ¬ ì²˜ë¦¬ UI

### 8.1 ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ

```python
try:
    response = agent_executor.invoke({
        "question": prompt,
        "difficulty": difficulty
    })
except Exception as e:
    st.error(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
    logger.write(f"UI ì—ëŸ¬: {e}")
```

### 8.2 ê²½ê³  ë©”ì‹œì§€

```python
# API í‚¤ ë¯¸ì„¤ì • ê²½ê³ 
if not os.getenv("OPENAI_API_KEY"):
    st.warning("âš ï¸ OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
    st.stop()
```

---

## 9. ì¶œì²˜ í‘œì‹œ

### 9.1 Expanderë¡œ ì¶œì²˜ í‘œì‹œ

```python
with st.expander("ğŸ“š ì°¸ê³  ë…¼ë¬¸"):
    for doc in response.get("source_documents", []):
        st.markdown(f"""
        **ì œëª©**: {doc.metadata.get('title', 'N/A')}
        **ì €ì**: {doc.metadata.get('authors', 'N/A')}
        **ì—°ë„**: {doc.metadata.get('year', 'N/A')}
        **URL**: {doc.metadata.get('url', 'N/A')}
        """)
        st.divider()
```

---

## 10. ì „ì²´ UI ì½”ë“œ êµ¬ì¡°

```python
import streamlit as st
from datetime import datetime
from src.agent.graph import create_agent
from langchain.callbacks import StreamlitCallbackHandler

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ë…¼ë¬¸ ë¦¬ë·° ì±—ë´‡", page_icon="ğŸ“š", layout="wide")
st.title("ğŸ“š ë…¼ë¬¸ ë¦¬ë·° ì±—ë´‡ (AI Agent + RAG)")

# ì‚¬ì´ë“œë°”
with st.sidebar:
    st.header("âš™ï¸ ì„¤ì •")
    difficulty = st.radio(
        "ğŸšï¸ ë‚œì´ë„ ì„ íƒ",
        options=["easy", "hard"],
        format_func=lambda x: "ì´ˆê¸‰" if x == "easy" else "ì „ë¬¸ê°€",
        index=0
    )
    if st.button("ğŸ”„ ëŒ€í™” ì´ˆê¸°í™”"):
        st.session_state.messages = []
        st.rerun()

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if "messages" not in st.session_state:
    st.session_state.messages = []

# Agent ì´ˆê¸°í™”
agent_executor = create_agent()

# ì±„íŒ… íˆìŠ¤í† ë¦¬ í‘œì‹œ
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# ì‚¬ìš©ì ì…ë ¥
if prompt := st.chat_input("ë…¼ë¬¸ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”..."):
    # ì‚¬ìš©ì ë©”ì‹œì§€
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    # Agent ì‹¤í–‰
    with st.chat_message("assistant"):
        st_callback = StreamlitCallbackHandler(st.container())

        try:
            with st.spinner("ğŸ¤– ë‹µë³€ ìƒì„± ì¤‘..."):
                response = agent_executor.invoke(
                    {"question": prompt, "difficulty": difficulty},
                    config={"callbacks": [st_callback]}
                )

            answer = response["final_answer"]
            st.markdown(answer)

            # ì¶œì²˜ í‘œì‹œ
            if "source_documents" in response:
                with st.expander("ğŸ“š ì°¸ê³  ë…¼ë¬¸"):
                    for doc in response["source_documents"]:
                        st.markdown(f"**{doc.metadata.get('title', 'N/A')}**")
                        st.caption(f"{doc.metadata.get('authors', 'N/A')} ({doc.metadata.get('year', 'N/A')})")
                        st.divider()

            # ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ ì¶”ê°€
            st.session_state.messages.append({"role": "assistant", "content": answer})

        except Exception as e:
            st.error(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
```

---

## 11. ì°¸ê³  ìë£Œ

- Streamlit Chat Elements: https://docs.streamlit.io/develop/api-reference/chat
- Langchain Streamlit: https://python.langchain.com/docs/integrations/callbacks/streamlit/
